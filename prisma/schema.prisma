datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

enum Bats {
  L
  R
  S
}

enum HomeAway {
  home
  away
}

model Team {
  id            Int     @id @default(autoincrement())
  name          String
  abbrev        String
  league        String
  division      String
  logoUrl       String?
  primaryParkId Int?

  primaryPark Park? @relation(fields: [primaryParkId], references: [id])

  homeGames         Game[]             @relation("HomeGames")
  awayGames         Game[]             @relation("AwayGames")
  teamGameStats     TeamGameHrStats[]
  playerGameStats   PlayerGameStats[]
  opponentGameStats TeamGameHrStats[]  @relation("OpponentTeam")
  teamSummaries     TeamHrSummary[]
  gamePredictions   GameHrPrediction[]
  players           Player[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Park {
  id              Int     @id @default(autoincrement())
  name            String
  city            String?
  state           String?
  country         String?
  defaultHrFactor Float?

  teams           Team[]
  games           Game[]
  teamGameStats   TeamGameHrStats[]
  playerGameStats PlayerGameStats[]
  parkHrFactors   ParkHrFactor[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Game {
  id        Int       @id @default(autoincrement())
  mlbGameId String?
  date      DateTime
  startTime DateTime?
  status    String
  season    Int
  homeScore Int?
  awayScore Int?

  homeTeamId Int
  awayTeamId Int
  parkId     Int

  homeTeam Team @relation("HomeGames", fields: [homeTeamId], references: [id])
  awayTeam Team @relation("AwayGames", fields: [awayTeamId], references: [id])
  park     Park @relation(fields: [parkId], references: [id])

  teamGameStats   TeamGameHrStats[]
  playerGameStats PlayerGameStats[]
  gamePredictions GameHrPrediction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
}

model TeamGameHrStats {
  id             Int      @id @default(autoincrement())
  gameId         Int
  teamId         Int
  opponentTeamId Int
  season         Int
  date           DateTime
  homeOrAway     String
  parkId         Int
  hr             Int
  xHr            Float?
  avgEv          Float?
  barrels        Int?
  barrelRate     Float?
  pa             Int?

  game         Game @relation(fields: [gameId], references: [id])
  team         Team @relation(fields: [teamId], references: [id])
  opponentTeam Team @relation("OpponentTeam", fields: [opponentTeamId], references: [id])
  park         Park @relation(fields: [parkId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId, date])
  @@index([gameId])
}

model Player {
  id         Int      @id @default(autoincrement())
  teamId     Int
  firstName  String
  lastName   String
  bats       Bats
  position   String
  heightCm   Int?
  weightKg   Int?
  mlbId      String?  @unique
  statcastId String?  @unique

  team            Team             @relation(fields: [teamId], references: [id])
  gameStats       PlayerGameStats[]
  hrSummaries     PlayerHrSummary[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([teamId])
  @@index([lastName, firstName, teamId])
}

model PlayerGameStats {
  id           Int       @id @default(autoincrement())
  playerId     Int
  gameId       Int
  teamId       Int
  season       Int
  date         DateTime
  homeOrAway   HomeAway
  matchupHand  Bats
  parkId       Int
  pa           Int
  hr           Int
  xHr          Float?
  avgEv        Float?
  barrels      Int?
  barrelRate   Float?
  hardHitRate  Float?
  iso          Float?
  woba         Float?

  player       Player @relation(fields: [playerId], references: [id])
  game         Game   @relation(fields: [gameId], references: [id])
  team         Team   @relation(fields: [teamId], references: [id])
  park         Park   @relation(fields: [parkId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([playerId, gameId])
  @@index([playerId, season])
  @@index([playerId, matchupHand])
  @@index([playerId, homeOrAway])
  @@index([playerId, parkId])
  @@index([teamId, season])
}

model PlayerHrSummary {
  id           Int      @id @default(autoincrement())
  playerId     Int
  season       Int
  splitKey     String
  gamesPlayed  Int
  pa           Int?
  hr           Int
  xHr          Float?
  hrPerPa      Float?
  barrelRate   Float?
  avgEv        Float?
  hardHitRate  Float?
  iso          Float?

  player       Player @relation(fields: [playerId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([playerId, season, splitKey])
  @@index([playerId, splitKey])
  @@index([season, splitKey])
}

model TeamHrSummary {
  id            Int       @id @default(autoincrement())
  teamId        Int
  season        Int
  fromDate      DateTime?
  toDate        DateTime?
  splitKey      String
  gamesPlayed   Int
  hr            Int
  xHr           Float?
  hrPerGame     Float
  hrPerPa       Float?
  hrVsLeaguePct Float?
  avgEv         Float?
  barrelRate    Float?

  team Team @relation(fields: [teamId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId, season, splitKey])
}

model ParkHrFactor {
  id            Int    @id @default(autoincrement())
  parkId        Int
  season        Int
  hrFactor      Float
  hrFactorVsLhp Float?
  hrFactorVsRhp Float?
  samples       Int?

  park Park @relation(fields: [parkId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parkId, season])
}

model GameHrPrediction {
  id                  Int      @id @default(autoincrement())
  gameId              Int
  teamId              Int
  modelVersion        String
  predictionTimestamp DateTime
  predictedHrMean     Float
  predictedHrStd      Float?
  hotbatScore         Float
  labelType           String
  featuresSnapshot    Json?

  game Game @relation(fields: [gameId], references: [id])
  team Team @relation(fields: [teamId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gameId, teamId])
}
