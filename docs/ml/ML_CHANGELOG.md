# ML Changelog (append-only)

- 2025-12-21: Init Phase 0 plan docs; baseline Retrosheet PA labeling script planned.
- 2025-12-21: Added DB connectivity notes (Supabase pooler + trusted CA), documented PA labeling command, and rebuilt PA labeling script for deterministic per-PA rows with HR labels and validation output.
- 2025-12-23: ML Phase 1 (Retrosheet-only): added `docs/ml/PA_DATA_CONTRACT.md`, new deterministic `scripts/ml/build_pa_events.py`, hardened `scripts/ml/build_player_pa_labels.py` (pa_id + stats + validations), and added `scripts/ml/eval_baseline.py` for baseline eval (logloss/Brier/top-K); no new dependencies.
- 2025-12-23: Added Player-Day feature materialization docs (`docs/ml/05_player_day_feature_plan.md`, `docs/ml/06_feature_building_rules.md`) and `scripts/ml/build_player_day_features.py` to generate `features_v1` batter/pitcher daily cumulative features with strict time-awareness (no leakage) and O(1) last-50 deltas.
- 2025-12-23: Added Player-Game baseline layer: `scripts/ml/build_player_game_baseline.py` materializes `scripts/ml/data/player_game_baseline.csv` from player-day features + slate + static park factors (stub supported), with deterministic joins and baseline score `hr_rate_last_50 * park_hr_factor * expected_pa` (no ML).
- 2025-12-23: Added canonical player identity registry: `scripts/ml/player_registry.py` builds `scripts/ml/data/player_registry.csv` from Retrosheet `.ROS` files and validates full coverage for all PA player_ids; `scripts/ml/build_player_game_baseline.py` now joins `player_name` from the registry and fails if any ID is unresolved (PA grain + `pa_id` unchanged).
- 2025-12-23: Updated `scripts/ml/example_daily_slate.csv` demo rows to use a late-season date so `player_game_baseline.csv` renders non-zero scores for validation/demo; no changes to PA or player-day logic.
- 2025-12-23: Replaced stub slate/park inputs with real game-derived context: added `scripts/ml/build_daily_slate_from_events.py` to parse Retrosheet event files and generate `scripts/ml/data/daily_slate.csv` (player_id, game_date, park_id, opposing_pitcher_id). Updated `scripts/ml/build_player_game_baseline.py` to consume the real slate by default and removed stub CSV inputs; `park_hr_factor` remains a documented neutral placeholder (1.00) until real park factors are added. Baseline formula and PA invariants unchanged.
- 2025-12-23: Extended `scripts/ml/build_player_game_baseline.py` to carry forward season totals (`season_hr`, `season_pa`) into `player_game_baseline.csv` for UI explainability (no new feature engineering; values come directly from `features_v1`). Baseline score formula unchanged.
- 2025-12-23: Refactored input sources to the organized, year-partitioned Retrosheet CSV datasets: `scripts/ml/build_daily_slate_from_events.py` now builds `daily_slate.csv` from daily logs (`batting.csv` + `gameinfo.csv`) joined to game logs (`glYYYY.txt`) for authoritative `park_id` + starting pitchers, and `scripts/ml/player_registry.py` now builds `player_registry.csv` from daily logs `allplayers.csv` (replacing `.ROS` parsing). Output schemas, PA grain, and `pa_id` invariants unchanged.
- 2025-12-23: Hardened daily-slate construction correctness checks: `scripts/ml/build_daily_slate_from_events.py` now asserts game log row width (161 fields), explicitly documents and sanity-checks starting pitcher field positions (102/104 IDs), and validates the `(date,home,away,number)` game key + `team/opp` consistency when joining `batting.csv` to `glYYYY.txt` (doubleheaders-safe). Output schema unchanged.
- 2025-12-23: Refactored PA ingestion to organized daily logs: `scripts/ml/build_pa_events.py` and `scripts/ml/build_player_pa_labels.py` now default to parsing daily logs `plays.csv` (`pa == 1`) instead of `data_sources/retrosheet/derived/events_csv`, while preserving the PA grain, `pa_id = {game_id}:{event_seq}` contract, and deterministic sorted outputs. Updated `docs/ml/PA_DATA_CONTRACT.md` and `docs/ml/ML_MVP_Plan.md` to document the daily logs source + event code derivation.
- 2025-12-23: Product wiring: upgraded the main HR Picks page (`/picks`) to be baseline-first using `public/data/player_game_baseline.csv`, with deterministic joins for player/team/park/pitcher names and handedness in `src/lib/baseline/fetchBaselineHrPicks.ts` and a canonical `CompareHRPick` UI contract (`src/features/hr-picks/types.ts`). No changes to PA grain, player-day features, or baseline score math.
- 2025-12-24: Data availability + UX: added `src/lib/dataAvailability.ts` as the single source of truth for CSV (date-derived seasons/dates) vs DB (actual seasons in DB) availability; `/picks` now uses a local Season+Date selector derived only from the baseline CSV and the global top-bar season selector is explicitly scoped to DB-only seasons. No changes to PA grain, player-day features, or baseline math.
- 2025-12-24: Added reproducible baseline QA utilities: `scripts/ml/validate_baseline.py` validates `scripts/ml/data/player_game_baseline.csv` invariants and compares baseline date coverage to Retrosheet game logs (`glYYYY.txt`), and `scripts/ml/build_season_metadata.py` materializes `scripts/ml/data/season_metadata.json` for “COVID/Partial” season badges in `/picks` without hardcoding seasons/dates in the UI. Also ignored `public/data/season_metadata.json` in git to keep generated UI artifacts local. No changes to PA grain or baseline score formula.
- 2025-12-24: Updated `scripts/ml/player_registry.py` to handle multi-season (2020–2025) roster name conflicts deterministically (nicknames/legal name changes/data quirks) while keeping `player_id` as the single canonical join key; added `--fail-on-conflicts` to optionally enforce strict failure. No changes to PA grain or `pa_id`.
- 2025-12-24: Added `scripts/ml/build_player_team_season_roster.py` to materialize a deterministic player-team-season roster table from daily logs `allplayers.csv` (`scripts/ml/data/player_team_season.csv`) while joining `player_name` exclusively from the canonical `player_registry.csv` (no duplicated name inference; PA grain + `pa_id` unchanged).
- 2025-12-24: Added `docs/data/RETROSHEET_STAT_MAP.md` to lock the “Retrosheet-only (no Statcast)” UI metric mapping and began CSV-first dashboard plumbing by adding daily logs loaders (`src/lib/csv/dailyBatting.ts`, `src/lib/csv/dailyPitching.ts`) and a CSV-backed mode for `GET /api/player-dashboard` (Retrosheet `player_id` supported; Statcast-only fields remain `null`). No changes to PA grain or `pa_id`.
- 2025-12-24: Completed CSV-first dashboard upgrades: `/api/player-dashboard` and `/api/team-dashboard` now prefer CSV in auto mode with DB fallback only when CSV is missing/empty; added PA-level recent-form windows (last 10/25/50 PA) from daily logs `plays.csv`, Retrosheet-based LHP/RHP splits with sample-size guards, and park factor estimates via `teamstats.csv`. Added lightweight CSV helpers (`src/lib/csv/dailyPlays.ts`, `src/lib/csv/parkFactors.ts`) and kept response shapes backward compatible (optional fields only).
- 2025-12-24: Added `scripts/ml/eval_baselines.py` to materialize v1 PA datasets (if missing), validate the v1 schema/labels, and evaluate time-split (train < 2024, test = 2024) baselines with log loss/Brier/calibration/lift metrics; outputs summary CSV + calibration JSON under `scripts/ml/data/reports`. No changes to PA grain or existing feature generation.
- 2025-12-24: Updated `scripts/ml/build_pa_events.py` to emit canonical ML v1 feature columns (`player_id`, `team_id`, `opponent_team_id`, `ballpark_id`, `pitcher_id`, `pitcher_hand`, `is_home`, `pa_index_in_game`) from daily logs `plays.csv` while keeping PA grain + `pa_id` unchanged; updated `docs/ml/PA_DATA_CONTRACT.md` accordingly.
- 2025-12-24: Added `scripts/ml/materialize_pa_features_v1.py` to generate `pa_features_v1_enriched.csv` with leakage-free rolling player/pitcher HR rates (last 10/25/50 PA), season-to-date and career-to-date rates, and park HR factor (league-normalized), using only prior PA history from `pa_features_v1.csv` + `pa_labels_v1.csv`.
- 2025-12-24: Added `scripts/ml/train_pa_logreg_v1.py` to train a simple logistic regression (no new deps) on `pa_features_v1_enriched.csv` with the fixed split (train < 2024, test = 2024), report log loss/Brier/lift, write calibration JSON, and export `pa_predictions_v1.csv`. No UI/API changes.
- 2025-12-24: Hardened `scripts/ml/train_pa_logreg_v1.py` sigmoid math with a numerically stable implementation to avoid overflow during training and calibration; outputs unchanged except for numerical stability.
- 2025-12-24: Fixed lift metric formatting in `scripts/ml/train_pa_logreg_v1.py` when lift is undefined (zero HR rate), preventing evaluation crashes.
- 2025-12-24: Updated `scripts/ml/materialize_pa_features_v1.py` to include `is_hr` in `pa_features_v1_enriched.csv` and made `scripts/ml/train_pa_logreg_v1.py` validate the label column explicitly to prevent silent all-zero training.
- 2025-12-24: Added categorical context for Phase 2B: `scripts/ml/materialize_pa_features_v1.py` now includes `batter_hand` and `ballpark_id_bucketed` (top 15 prior parks), and `scripts/ml/train_pa_logreg_v1.py` one-hot encodes categorical features with L2 regularization, exporting `pa_predictions_v1_cat.csv` and `pa_logreg_v1_cat_calibration.json`.
- 2025-12-24: Added `matchup_rate` interaction (player season-to-date HR rate × pitcher season-to-date HR allowed rate) to `pa_features_v1_enriched.csv` and retrained logistic regression with this numeric feature, exporting `pa_predictions_v1_matchup.csv` and `pa_logreg_v1_matchup_calibration.json` plus baseline log-loss deltas.
- 2025-12-24: Added Phase 3 GBDT trainer `scripts/ml/train_pa_gbdt_v1.py` (sklearn GradientBoostingClassifier, numeric features only, fixed train/test split) with raw + calibrated metrics and outputs (`pa_predictions_v1_gbdt.csv`, `pa_gbdt_v1_calibration.json`); documented `requirements-ml.txt` for scikit-learn. No UI/API changes.
- 2025-12-24: Added `scripts/ml/build_player_game_rankings_v1.py` to aggregate PA-level GBDT scores into player-game rankings (`player_game_hr_rankings_v1.csv`) using max score and ≥1 HR probability; keeps CSV-only, deterministic outputs. Updated GBDT prediction exports to include game/team context for aggregation.
- 2025-12-24: Added `scripts/ml/train_pa_gbdt_v1_all_seasons.py` to train per season (train on seasons < Y, score season Y) and write `pa_predictions_v1_gbdt_all_seasons.csv` plus per-season metrics summary (`pa_gbdt_v1_all_seasons_summary.csv`). `build_player_game_rankings_v1.py` now supports `--input/--output` to rank alternate prediction files. No UI/API changes.
- 2025-12-24: Wired `/picks` to prefer ML rankings via `fetchMlHrPicks` (reads `player_game_hr_rankings_v1_all_seasons.csv` when available, falls back to baseline), keeping existing UI contracts and baseline explainability intact.
- 2025-12-24: Phase 4A explainability scaffolding: `build_player_game_rankings_v1.py` now appends offline explainability columns (`player_recent_hr_rate`, `pitcher_recent_hr_allowed_rate`, `park_hr_factor`, `matchup_rate`, `top_signal`), writes `model_versions.json`, and includes invariant checks; added `validate_rankings_v1.py` and `publish_rankings.py` helpers.
- 2025-12-24: Fixed Phase 4A ranking diagnostics in `build_player_game_rankings_v1.py` by replacing an f-string in the non-null summary print with `.format` to prevent accidental escaping errors; no ranking or output changes.
- 2025-12-24: Phase 4B UI wiring: `/picks` now optionally surfaces ML explainability tooltips using additive fields from the rankings CSV (`top_signal`, recent rate signals, matchup/park context) without changing ranking order or baseline fallback behavior.
- 2025-12-24: Added dev-only model version badge on `/picks` (from `model_versions.json`) and optional confidence labels computed from ML aggregate HR probabilities; no ranking logic or output ordering changes.
- 2025-12-24: Phase 5 monitoring: added `scripts/ml/monitor_hr_picks_v1.py` to compute daily top-5/top-10 ML hit rates with baseline and random expectations (CSV-only), plus `docs/frontend/ML_PICKS_COPY.md` with product copy and explainability phrasing guidance.
- 2025-12-24: Phase 5.5 trust UX: `/picks` now shows model status from monitoring CSV, top edge highlight, movement notes, and confidence tiers; explainability bullets rewritten in broadcast-style language. Ranking order and baseline fallback unchanged.
- 2025-12-24: Phase 6 trust/stability UX: added rank stability labels, yesterday recap line (monitoring CSV), confidence tier definitions in tooltip, and tightened movement wording. No ranking changes; baseline fallback stays silent.
