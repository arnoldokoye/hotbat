# ML Changelog (append-only)

- 2025-12-21: Init Phase 0 plan docs; baseline Retrosheet PA labeling script planned.
- 2025-12-21: Added DB connectivity notes (Supabase pooler + trusted CA), documented PA labeling command, and rebuilt PA labeling script for deterministic per-PA rows with HR labels and validation output.
- 2025-12-23: ML Phase 1 (Retrosheet-only): added `docs/ml/PA_DATA_CONTRACT.md`, new deterministic `scripts/ml/build_pa_events.py`, hardened `scripts/ml/build_player_pa_labels.py` (pa_id + stats + validations), and added `scripts/ml/eval_baseline.py` for baseline eval (logloss/Brier/top-K); no new dependencies.
- 2025-12-23: Added Player-Day feature materialization docs (`docs/ml/05_player_day_feature_plan.md`, `docs/ml/06_feature_building_rules.md`) and `scripts/ml/build_player_day_features.py` to generate `features_v1` batter/pitcher daily cumulative features with strict time-awareness (no leakage) and O(1) last-50 deltas.
- 2025-12-23: Added Player-Game baseline layer: `scripts/ml/build_player_game_baseline.py` materializes `scripts/ml/data/player_game_baseline.csv` from player-day features + slate + static park factors (stub supported), with deterministic joins and baseline score `hr_rate_last_50 * park_hr_factor * expected_pa` (no ML).
- 2025-12-23: Added canonical player identity registry: `scripts/ml/player_registry.py` builds `scripts/ml/data/player_registry.csv` from Retrosheet `.ROS` files and validates full coverage for all PA player_ids; `scripts/ml/build_player_game_baseline.py` now joins `player_name` from the registry and fails if any ID is unresolved (PA grain + `pa_id` unchanged).
- 2025-12-23: Updated `scripts/ml/example_daily_slate.csv` demo rows to use a late-season date so `player_game_baseline.csv` renders non-zero scores for validation/demo; no changes to PA or player-day logic.
- 2025-12-23: Replaced stub slate/park inputs with real game-derived context: added `scripts/ml/build_daily_slate_from_events.py` to parse Retrosheet event files and generate `scripts/ml/data/daily_slate.csv` (player_id, game_date, park_id, opposing_pitcher_id). Updated `scripts/ml/build_player_game_baseline.py` to consume the real slate by default and removed stub CSV inputs; `park_hr_factor` remains a documented neutral placeholder (1.00) until real park factors are added. Baseline formula and PA invariants unchanged.
- 2025-12-23: Extended `scripts/ml/build_player_game_baseline.py` to carry forward season totals (`season_hr`, `season_pa`) into `player_game_baseline.csv` for UI explainability (no new feature engineering; values come directly from `features_v1`). Baseline score formula unchanged.
- 2025-12-23: Refactored input sources to the organized, year-partitioned Retrosheet CSV datasets: `scripts/ml/build_daily_slate_from_events.py` now builds `daily_slate.csv` from daily logs (`batting.csv` + `gameinfo.csv`) joined to game logs (`glYYYY.txt`) for authoritative `park_id` + starting pitchers, and `scripts/ml/player_registry.py` now builds `player_registry.csv` from daily logs `allplayers.csv` (replacing `.ROS` parsing). Output schemas, PA grain, and `pa_id` invariants unchanged.
- 2025-12-23: Hardened daily-slate construction correctness checks: `scripts/ml/build_daily_slate_from_events.py` now asserts game log row width (161 fields), explicitly documents and sanity-checks starting pitcher field positions (102/104 IDs), and validates the `(date,home,away,number)` game key + `team/opp` consistency when joining `batting.csv` to `glYYYY.txt` (doubleheaders-safe). Output schema unchanged.
- 2025-12-23: Refactored PA ingestion to organized daily logs: `scripts/ml/build_pa_events.py` and `scripts/ml/build_player_pa_labels.py` now default to parsing daily logs `plays.csv` (`pa == 1`) instead of `data_sources/retrosheet/derived/events_csv`, while preserving the PA grain, `pa_id = {game_id}:{event_seq}` contract, and deterministic sorted outputs. Updated `docs/ml/PA_DATA_CONTRACT.md` and `docs/ml/ML_MVP_Plan.md` to document the daily logs source + event code derivation.
- 2025-12-23: Product wiring: upgraded the main HR Picks page (`/picks`) to be baseline-first using `public/data/player_game_baseline.csv`, with deterministic joins for player/team/park/pitcher names and handedness in `src/lib/baseline/fetchBaselineHrPicks.ts` and a canonical `CompareHRPick` UI contract (`src/features/hr-picks/types.ts`). No changes to PA grain, player-day features, or baseline score math.
- 2025-12-24: Data availability + UX: added `src/lib/dataAvailability.ts` as the single source of truth for CSV (date-derived seasons/dates) vs DB (actual seasons in DB) availability; `/picks` now uses a local Season+Date selector derived only from the baseline CSV and the global top-bar season selector is explicitly scoped to DB-only seasons. No changes to PA grain, player-day features, or baseline math.
- 2025-12-24: Added reproducible baseline QA utilities: `scripts/ml/validate_baseline.py` validates `scripts/ml/data/player_game_baseline.csv` invariants and compares baseline date coverage to Retrosheet game logs (`glYYYY.txt`), and `scripts/ml/build_season_metadata.py` materializes `scripts/ml/data/season_metadata.json` for “COVID/Partial” season badges in `/picks` without hardcoding seasons/dates in the UI. Also ignored `public/data/season_metadata.json` in git to keep generated UI artifacts local. No changes to PA grain or baseline score formula.
- 2025-12-24: Updated `scripts/ml/player_registry.py` to handle multi-season (2020–2025) roster name conflicts deterministically (nicknames/legal name changes/data quirks) while keeping `player_id` as the single canonical join key; added `--fail-on-conflicts` to optionally enforce strict failure. No changes to PA grain or `pa_id`.
- 2025-12-24: Added `scripts/ml/build_player_team_season_roster.py` to materialize a deterministic player-team-season roster table from daily logs `allplayers.csv` (`scripts/ml/data/player_team_season.csv`) while joining `player_name` exclusively from the canonical `player_registry.csv` (no duplicated name inference; PA grain + `pa_id` unchanged).
- 2025-12-24: Added `docs/data/RETROSHEET_STAT_MAP.md` to lock the “Retrosheet-only (no Statcast)” UI metric mapping and began CSV-first dashboard plumbing by adding daily logs loaders (`src/lib/csv/dailyBatting.ts`, `src/lib/csv/dailyPitching.ts`) and a CSV-backed mode for `GET /api/player-dashboard` (Retrosheet `player_id` supported; Statcast-only fields remain `null`). No changes to PA grain or `pa_id`.
